<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crypto DCA Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    
    <!-- Firebase v9 - More reliable -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
        import { getDatabase, ref, set, get, onValue } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js';
        
        window.firebaseModules = { initializeApp, getDatabase, ref, set, get, onValue };
    </script>
</head>
<body class="bg-gradient-to-br from-gray-50 to-gray-100">
    
    <!-- Firebase Setup Modal -->
    <div id="firebaseSetupModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl p-6 md:p-8 max-w-3xl w-full mx-4 max-h-screen overflow-y-auto">
            <h2 class="text-2xl font-bold text-gray-900 mb-4">üî• Firebase Setup</h2>
            <p class="text-gray-600 mb-6">Eenmalige setup voor automatische synchronisatie tussen al je apparaten.</p>
            
            <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-6">
                <h3 class="font-bold text-blue-900 mb-2">üìã Wat je nodig hebt:</h3>
                <ol class="list-decimal list-inside space-y-2 text-sm text-blue-800">
                    <li>Ga naar <a href="https://console.firebase.google.com" target="_blank" class="underline font-semibold">console.firebase.google.com</a></li>
                    <li>Klik op "Create a project" (of "Project toevoegen")</li>
                    <li>Geef het een naam (bijv. "crypto-dashboard")</li>
                    <li>Google Analytics kan uit (niet nodig)</li>
                    <li>Wacht tot project is aangemaakt</li>
                    <li>Klik op "Web" (het </> icoontje)</li>
                    <li>Geef je app een naam en klik "Register app"</li>
                    <li>Kopieer de <strong>firebaseConfig</strong> die je ziet</li>
                </ol>
            </div>

            <div class="bg-yellow-50 border-l-4 border-yellow-500 p-4 mb-6">
                <h3 class="font-bold text-yellow-900 mb-2">‚öôÔ∏è Realtime Database activeren:</h3>
                <ol class="list-decimal list-inside space-y-1 text-sm text-yellow-800">
                    <li>Ga in Firebase naar "Build" ‚Üí "Realtime Database"</li>
                    <li>Klik "Create Database"</li>
                    <li>Kies een locatie (bijv. europe-west1)</li>
                    <li>Start in <strong>"test mode"</strong></li>
                    <li>Klik "Enable"</li>
                </ol>
            </div>

            <div class="space-y-3 mb-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">API Key:</label>
                    <input type="text" id="fbApiKey" placeholder="AIza..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Auth Domain:</label>
                    <input type="text" id="fbAuthDomain" placeholder="jouw-project.firebaseapp.com" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Database URL:</label>
                    <input type="text" id="fbDatabaseURL" placeholder="https://jouw-project-default-rtdb.europe-west1.firebasedatabase.app" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Project ID:</label>
                    <input type="text" id="fbProjectId" placeholder="jouw-project" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
            </div>

            <div class="flex gap-3">
                <button onclick="saveFirebaseConfig()" class="flex-1 bg-blue-600 text-white px-6 py-3 rounded-lg font-medium hover:bg-blue-700 transition-colors">
                    üíæ Opslaan en Verbinden
                </button>
                <button onclick="skipFirebaseSetup()" class="px-6 py-3 border border-gray-300 rounded-lg font-medium hover:bg-gray-50 transition-colors">
                    Later
                </button>
            </div>

            <div class="mt-4 text-xs text-gray-500">
                <p>üí° Tip: Deze gegevens worden lokaal opgeslagen. Op andere apparaten moet je ze opnieuw invoeren.</p>
            </div>
        </div>
    </div>

    <div class="min-h-screen p-4 md:p-8">
        <div class="max-w-7xl mx-auto">
            <!-- Header -->
            <div class="mb-6 md:mb-8">
                <h1 class="text-3xl md:text-4xl font-bold text-gray-900 mb-2">Crypto DCA Dashboard</h1>
                <p class="text-gray-600 text-sm md:text-base">Overzicht van je Bitcoin en XRP investeringen</p>
                
                <!-- Live Price Ticker -->
                <div class="mt-3 flex flex-wrap items-center gap-4 bg-white rounded-lg p-3 shadow-sm">
                    <div class="flex items-center gap-2">
                        <span class="text-orange-500 font-bold">‚Çø BTC:</span>
                        <span id="liveBtcPrice" class="font-semibold text-gray-900">‚Ç¨--,---</span>
                        <span id="btcChange" class="text-xs"></span>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="text-gray-800 font-bold">‚äó XRP:</span>
                        <span id="liveXrpPrice" class="font-semibold text-gray-900">‚Ç¨--.--</span>
                        <span id="xrpChange" class="text-xs"></span>
                    </div>
                    <div class="ml-auto flex items-center gap-2 text-xs text-gray-500">
                        <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse" id="apiStatus"></span>
                        <span id="lastUpdate">Laden...</span>
                    </div>
                </div>
                
                <div id="syncStatus" class="mt-2 text-sm flex items-center gap-3 flex-wrap">
                    <span class="inline-flex items-center gap-2">
                        <span class="w-2 h-2 rounded-full bg-gray-400" id="statusDot"></span>
                        <span class="text-gray-600" id="statusText">Laden...</span>
                    </span>
                    <button onclick="showFirebaseSetup()" class="text-blue-600 hover:underline text-xs">‚öôÔ∏è Firebase Setup</button>
                    <button onclick="exportData()" class="text-blue-600 hover:underline text-xs">üì§ Exporteren</button>
                    <button onclick="importData()" class="text-blue-600 hover:underline text-xs">üì• Importeren</button>
                </div>
            </div>

            <!-- Tabs -->
            <div class="mb-6 flex flex-wrap gap-2 md:gap-4 border-b border-gray-200">
                <button id="dashboardTab" class="px-4 md:px-6 py-3 font-medium border-b-2 border-blue-600 text-blue-600 text-sm md:text-base">
                    üìä Dashboard
                </button>
                <button id="inputTab" class="px-4 md:px-6 py-3 font-medium text-gray-600 hover:text-gray-900 text-sm md:text-base">
                    ‚ûï Invoeren
                </button>
                <button onclick="exportToExcel()" class="md:ml-auto px-4 md:px-6 py-3 font-medium bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors text-sm md:text-base">
                    üì• Excel
                </button>
            </div>

            <!-- Dashboard Content -->
            <div id="dashboardContent">
                <!-- Stats Cards -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-6 gap-4 md:gap-6 mb-6 md:mb-8">
                    <div class="bg-white rounded-lg shadow-md p-4 md:p-6 border-l-4 border-green-600">
                        <p class="text-xs md:text-sm font-medium text-gray-600">üí∞ Cash Saldo</p>
                        <p class="text-xl md:text-2xl font-bold text-gray-900 mt-2" id="cashSaldo">‚Ç¨0.00</p>
                        <p class="text-xs md:text-sm text-gray-500 mt-1">Beschikbaar</p>
                    </div>
                    <div class="bg-white rounded-lg shadow-md p-4 md:p-6 border-l-4 border-blue-600">
                        <p class="text-xs md:text-sm font-medium text-gray-600">Totale Inleg</p>
                        <p class="text-xl md:text-2xl font-bold text-gray-900 mt-2" id="totaleInleg">‚Ç¨0.00</p>
                        <p class="text-xs md:text-sm text-gray-500 mt-1">In crypto</p>
                    </div>
                    <div class="bg-white rounded-lg shadow-md p-4 md:p-6 border-l-4 border-purple-600">
                        <p class="text-xs md:text-sm font-medium text-gray-600">Huidige Waarde</p>
                        <p class="text-xl md:text-2xl font-bold text-gray-900 mt-2" id="huidigeWaarde">‚Ç¨0.00</p>
                        <p class="text-xs md:text-sm text-gray-500 mt-1">Portfolio waarde</p>
                    </div>
                    <div class="bg-white rounded-lg shadow-md p-4 md:p-6 border-l-4" id="rendementCard">
                        <p class="text-xs md:text-sm font-medium text-gray-600">Total P&L</p>
                        <p class="text-xl md:text-2xl font-bold text-gray-900 mt-2" id="rendementBedrag">‚Ç¨0.00</p>
                        <div class="mt-2 text-xs text-gray-600">
                            <div>Realized: <span id="realizedPL" class="font-semibold">‚Ç¨0.00</span></div>
                            <div>Unrealized: <span id="unrealizedPL" class="font-semibold">‚Ç¨0.00</span></div>
                        </div>
                    </div>
                    <div class="bg-white rounded-lg shadow-md p-4 md:p-6 border-l-4 border-orange-500">
                        <p class="text-xs md:text-sm font-medium text-gray-600">Gem. Prijs BTC</p>
                        <p class="text-xl md:text-2xl font-bold text-gray-900 mt-2" id="btcGemKoers">‚Ç¨0.00</p>
                        <p class="text-xs md:text-sm text-gray-500 mt-1" id="btcHoeveelheid">0.000000 BTC</p>
                    </div>
                    <div class="bg-white rounded-lg shadow-md p-4 md:p-6 border-l-4 border-gray-800">
                        <p class="text-xs md:text-sm font-medium text-gray-600">Gem. Prijs XRP</p>
                        <p class="text-xl md:text-2xl font-bold text-gray-900 mt-2" id="xrpGemKoers">‚Ç¨0.00</p>
                        <p class="text-xs md:text-sm text-gray-500 mt-1" id="xrpHoeveelheid">0.00 XRP</p>
                    </div>
                </div>

                <!-- Charts -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 md:gap-6 mb-6 md:mb-8">
                    <div class="bg-white rounded-lg shadow-md p-4 md:p-6">
                        <h3 class="text-base md:text-lg font-semibold text-gray-900 mb-4">Waarde Ontwikkeling BTC</h3>
                        <canvas id="btcChart"></canvas>
                    </div>
                    <div class="bg-white rounded-lg shadow-md p-4 md:p-6">
                        <h3 class="text-base md:text-lg font-semibold text-gray-900 mb-4">Waarde Ontwikkeling XRP</h3>
                        <canvas id="xrpChart"></canvas>
                    </div>
                </div>

                <div class="grid grid-cols-1 gap-4 md:gap-6 mb-6 md:mb-8">
                    <div class="bg-white rounded-lg shadow-md p-4 md:p-6">
                        <h3 class="text-base md:text-lg font-semibold text-gray-900 mb-4">Rendement BTC & XRP</h3>
                        <canvas id="rendementChart"></canvas>
                    </div>
                </div>

                <div class="grid grid-cols-1 gap-4 md:gap-6 mb-6 md:mb-8">
                    <div class="bg-white rounded-lg shadow-md p-4 md:p-6">
                        <h3 class="text-base md:text-lg font-semibold text-gray-900 mb-4">üí∞ Cash Flow - Funding & Trading</h3>
                        <canvas id="cashChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Input Content -->
            <div id="inputContent" class="hidden">
                <!-- Cash Management -->
                <div class="bg-white rounded-lg shadow-md p-4 md:p-6 mb-6 border-l-4 border-green-600">
                    <h2 class="text-xl md:text-2xl font-bold text-gray-900 mb-4">üí∞ Cash Management</h2>
                    <p class="text-sm text-gray-600 mb-4">Voeg wekelijkse funding toe (bijv. ‚Ç¨140) of verkoop crypto voor cash</p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Datum</label>
                            <input type="date" id="cashDatum" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Bedrag (‚Ç¨)</label>
                            <input type="number" step="0.01" placeholder="140.00" id="cashBedrag" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                        </div>
                    </div>

                    <div class="grid grid-cols-1 gap-4">
                        <button onclick="addCashFunding()" class="bg-green-600 text-white px-6 py-3 rounded-lg font-medium hover:bg-green-700 transition-colors">
                            üíµ Cash Toevoegen
                        </button>
                    </div>
                </div>

                <!-- Current Prices -->
                <div class="bg-white rounded-lg shadow-md p-4 md:p-6 mb-6">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-xl md:text-2xl font-bold text-gray-900">Historische Koersen</h2>
                        <span class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded-full">‚ú® Automatisch opgeslagen</span>
                    </div>
                    <p class="text-sm text-gray-600 mb-4">Dagelijkse koersen worden automatisch opgeslagen. Handmatig opslaan alleen voor correcties of oude data.</p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Datum</label>
                            <input type="date" id="snapshotDatum" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">BTC Koers (‚Ç¨) - Optioneel</label>
                            <input type="number" step="0.01" placeholder="Automatisch" id="huidigebtcKoers" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">XRP Koers (‚Ç¨) - Optioneel</label>
                            <input type="number" step="0.01" placeholder="Automatisch" id="huidigexrpKoers" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>

                    <button onclick="updateCurrentPrices()" class="w-full bg-green-600 text-white px-6 py-3 rounded-lg font-medium hover:bg-green-700 transition-colors">
                        üíæ Handmatig Koers Opslaan
                    </button>
                </div>

                <!-- Input Form -->
                <div class="bg-white rounded-lg shadow-md p-4 md:p-6 mb-6">
                    <h2 class="text-xl md:text-2xl font-bold text-gray-900 mb-4">Nieuwe Aankoop</h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Datum</label>
                            <input type="date" id="inputDatum" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Crypto</label>
                            <select id="inputCrypto" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="BTC">Bitcoin (BTC)</option>
                                <option value="XRP">Ripple (XRP)</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Bedrag (‚Ç¨)</label>
                            <input type="number" step="0.01" placeholder="15.00" id="inputBedrag" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Hoeveelheid</label>
                            <input type="number" step="0.00000001" placeholder="0.00024" id="inputHoeveelheid" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>

                    <div id="koersPreview" class="mb-4 p-4 bg-blue-50 rounded-lg hidden">
                        <p class="text-sm text-gray-600">Berekende koers:</p>
                        <p class="text-2xl font-bold text-blue-600" id="berekendKoers">‚Ç¨0.00</p>
                        <p class="text-xs text-gray-500 mt-1" id="koersPer">per BTC</p>
                    </div>

                    <button onclick="addTransaction()" class="w-full bg-blue-600 text-white px-6 py-3 rounded-lg font-medium hover:bg-blue-700 transition-colors">
                        ‚ûï Aankoop Toevoegen
                    </button>
                </div>

                <!-- Sell Form -->
                <div class="bg-white rounded-lg shadow-md p-4 md:p-6 mb-6 border-l-4 border-orange-600">
                    <h2 class="text-xl md:text-2xl font-bold text-gray-900 mb-4">üì§ Verkoop Crypto</h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Datum</label>
                            <input type="date" id="sellDatum" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Crypto</label>
                            <select id="sellCrypto" onchange="updateSellHoldings()" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500">
                                <option value="BTC">Bitcoin (BTC)</option>
                                <option value="XRP">Ripple (XRP)</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Hoeveelheid</label>
                            <input type="number" step="0.00000001" placeholder="0.00024" id="sellHoeveelheid" oninput="updateSellPreview()" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500">
                            <p class="text-xs text-gray-500 mt-1">Beschikbaar: <span id="availableHoldings" class="font-semibold text-green-600">0.00000000</span></p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Verkoopprijs (‚Ç¨)</label>
                            <input type="number" step="0.01" placeholder="65000.00" id="sellKoers" oninput="updateSellPreview()" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500">
                        </div>
                    </div>

                    <div id="sellPreview" class="mb-4 p-4 bg-orange-50 border border-orange-200 rounded-lg hidden">
                        <div class="grid grid-cols-3 gap-4 text-center">
                            <div>
                                <p class="text-xs text-gray-600">Ontvangst</p>
                                <p class="text-lg font-bold text-orange-600" id="sellOntvangst">‚Ç¨0.00</p>
                            </div>
                            <div>
                                <p class="text-xs text-gray-600">Cost Basis</p>
                                <p class="text-lg font-bold text-gray-700" id="sellCostBasis">‚Ç¨0.00</p>
                            </div>
                            <div>
                                <p class="text-xs text-gray-600">Winst/Verlies</p>
                                <p class="text-lg font-bold" id="sellProfit">‚Ç¨0.00</p>
                            </div>
                        </div>
                    </div>

                    <button onclick="sellCrypto()" class="w-full bg-orange-600 text-white px-6 py-3 rounded-lg font-medium hover:bg-orange-700 transition-colors">
                        üì§ Verkopen
                    </button>
                </div>

                <!-- Transaction Lists -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 md:gap-6">
                    <div class="bg-white rounded-lg shadow-md p-4 md:p-6">
                        <h3 class="text-lg md:text-xl font-bold text-gray-900 mb-4 flex items-center gap-2">
                            <div class="w-3 h-3 rounded-full bg-orange-500"></div>
                            Bitcoin Aankopen
                        </h3>
                        <div id="btcList" class="space-y-2 max-h-96 overflow-y-auto"></div>
                        <div class="mt-4 pt-4 border-t border-gray-200">
                            <div class="flex justify-between text-sm">
                                <span class="font-medium">Totaal:</span>
                                <span class="font-bold" id="btcTotaalInleg">‚Ç¨0.00</span>
                            </div>
                            <div class="flex justify-between text-sm mt-1">
                                <span class="font-medium">BTC:</span>
                                <span class="font-bold" id="btcTotaalHoeveelheid">0.00000000</span>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-lg shadow-md p-4 md:p-6">
                        <h3 class="text-lg md:text-xl font-bold text-gray-900 mb-4 flex items-center gap-2">
                            <div class="w-3 h-3 rounded-full bg-gray-800"></div>
                            Ripple Aankopen
                        </h3>
                        <div id="xrpList" class="space-y-2 max-h-96 overflow-y-auto"></div>
                        <div class="mt-4 pt-4 border-t border-gray-200">
                            <div class="flex justify-between text-sm">
                                <span class="font-medium">Totaal:</span>
                                <span class="font-bold" id="xrpTotaalInleg">‚Ç¨0.00</span>
                            </div>
                            <div class="flex justify-between text-sm mt-1">
                                <span class="font-medium">XRP:</span>
                                <span class="font-bold" id="xrpTotaalHoeveelheid">0.00</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Firebase configuration - PRE-CONFIGURED
        let firebaseConfig = {
            apiKey: "AIzaSyACziIk-vZiQsORvraWKpYi5mv5JMjdns0",
            authDomain: "dca-en.firebaseapp.com",
            databaseURL: "https://dca-en-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "dca-en"
        };
        
        // Save to localStorage
        localStorage.setItem('firebaseConfig', JSON.stringify(firebaseConfig));
        
        let database = null;
        let firebaseInitialized = false;

        // Data
        let btcTransactions = [];
        let xrpTransactions = [];
        let currentBtcPrice = 60576.69;
        let currentXrpPrice = 1.23;
        let priceSnapshots = [];
        let btcChart, xrpChart, rendementChart, cashChart;
        
        // Cash Management - NEW
        let cashTransactions = []; // {datum, type: 'funding'|'buy'|'sell', bedrag, crypto?, notes?}
        
        // Price tracking
        let lastBtcPrice = 0;
        let lastXrpPrice = 0;
        let priceUpdateInterval = null;

        // CoinGecko API - Free, no API key needed!
        async function fetchLivePrices(retryCount = 0) {
            try {
                const response = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=bitcoin,ripple&vs_currencies=eur&include_24hr_change=true');
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.bitcoin && data.ripple) {
                    // Update prices
                    lastBtcPrice = currentBtcPrice;
                    lastXrpPrice = currentXrpPrice;
                    
                    currentBtcPrice = data.bitcoin.eur;
                    currentXrpPrice = data.ripple.eur;
                    
                    // Update UI
                    updateLivePriceTicker(data);
                    
                    // Auto-save daily snapshot
                    await autoSaveDailySnapshot();
                    
                    // Update dashboard with new prices
                    updateDashboard();
                    
                    // Update Firebase
                    saveCurrentPricesToFirebase();
                    
                    return true;
                }
            } catch (error) {
                console.error('Error fetching prices:', error);
                
                // Retry up to 3 times with exponential backoff
                if (retryCount < 3) {
                    const delay = Math.pow(2, retryCount) * 1000; // 1s, 2s, 4s
                    console.log(`Retrying in ${delay/1000}s... (attempt ${retryCount + 1}/3)`);
                    setTimeout(() => fetchLivePrices(retryCount + 1), delay);
                    return false;
                }
                
                document.getElementById('apiStatus').className = 'w-2 h-2 rounded-full bg-yellow-500';
                document.getElementById('lastUpdate').textContent = 'Offline mode';
                return false;
            }
        }

        function updateLivePriceTicker(data) {
            // BTC Price
            const btcPrice = data.bitcoin.eur;
            const btcChange = data.bitcoin.eur_24h_change;
            document.getElementById('liveBtcPrice').textContent = '‚Ç¨' + btcPrice.toLocaleString('nl-NL', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            
            const btcChangeEl = document.getElementById('btcChange');
            const btcArrow = btcChange >= 0 ? '‚Üë' : '‚Üì';
            btcChangeEl.textContent = btcArrow + Math.abs(btcChange).toFixed(1) + '%';
            btcChangeEl.className = btcChange >= 0 ? 'text-xs text-green-600 font-semibold' : 'text-xs text-red-600 font-semibold';
            
            // XRP Price
            const xrpPrice = data.ripple.eur;
            const xrpChange = data.ripple.eur_24h_change;
            document.getElementById('liveXrpPrice').textContent = '‚Ç¨' + xrpPrice.toFixed(2);
            
            const xrpChangeEl = document.getElementById('xrpChange');
            const xrpArrow = xrpChange >= 0 ? '‚Üë' : '‚Üì';
            xrpChangeEl.textContent = xrpArrow + Math.abs(xrpChange).toFixed(1) + '%';
            xrpChangeEl.className = xrpChange >= 0 ? 'text-xs text-green-600 font-semibold' : 'text-xs text-red-600 font-semibold';
            
            // Update status
            document.getElementById('apiStatus').className = 'w-2 h-2 rounded-full bg-green-500 animate-pulse';
            const now = new Date();
            document.getElementById('lastUpdate').textContent = 'Bijgewerkt: ' + now.toLocaleTimeString('nl-NL', {hour: '2-digit', minute: '2-digit'});
        }

        async function autoSaveDailySnapshot() {
            // Get today's date
            const today = new Date().toISOString().split('T')[0];
            
            // Check if we already have a snapshot for today
            const existingSnapshot = priceSnapshots.find(s => s.datum === today);
            
            if (!existingSnapshot) {
                // Create new snapshot for today
                const newSnapshot = {
                    datum: today,
                    btcKoers: currentBtcPrice,
                    xrpKoers: currentXrpPrice
                };
                
                priceSnapshots.push(newSnapshot);
                priceSnapshots.sort((a, b) => new Date(a.datum) - new Date(b.datum));
                
                // Save to Firebase
                saveToFirebase();
                
                console.log('‚úÖ Daily snapshot saved for', today, 'BTC:', currentBtcPrice, 'XRP:', currentXrpPrice);
            }
            // If snapshot exists, don't update it - we want the opening price, not latest price
        }

        async function backfillHistoricalPrices() {
            // Get all unique dates from transactions
            const allDates = new Set();
            btcTransactions.forEach(t => allDates.add(t.datum));
            xrpTransactions.forEach(t => allDates.add(t.datum));
            
            // Check which dates are missing snapshots
            const missingDates = Array.from(allDates).filter(date => {
                return !priceSnapshots.find(s => s.datum === date);
            });
            
            if (missingDates.length === 0) {
                console.log('‚úÖ All historical snapshots present');
                return;
            }
            
            console.log(`üìä Backfilling ${missingDates.length} missing snapshots...`);
            
            let filled = 0;
            
            // For missing dates, use transaction prices as best estimate
            missingDates.forEach(date => {
                const btcTx = btcTransactions.find(t => t.datum === date);
                const xrpTx = xrpTransactions.find(t => t.datum === date);
                
                // Use transaction price, or fallback to current if no transaction on that date
                const snapshot = {
                    datum: date,
                    btcKoers: btcTx ? btcTx.koers : currentBtcPrice,
                    xrpKoers: xrpTx ? xrpTx.koers : currentXrpPrice
                };
                
                priceSnapshots.push(snapshot);
                filled++;
            });
            
            priceSnapshots.sort((a, b) => new Date(a.datum) - new Date(b.datum));
            
            // Save to Firebase
            saveToFirebase();
            
            console.log(`‚úÖ Backfill complete! Added ${filled} snapshots.`);
            console.log(`üìä Total snapshots now: ${priceSnapshots.length}`);
            
            // Update dashboard with new snapshots
            updateDashboard();
        }

        function saveCurrentPricesToFirebase() {
            if (!database || !window.dbSet || !window.dbRef) return;
            
            const { ref, set } = window.firebaseModules;
            set(ref(database, 'currentPrices'), {
                btc: currentBtcPrice,
                xrp: currentXrpPrice,
                lastUpdate: new Date().toISOString()
            });
        }

        // Start price updates
        function startPriceUpdates() {
            // Initial fetch
            fetchLivePrices();
            
            // Update every 30 seconds
            priceUpdateInterval = setInterval(fetchLivePrices, 30000);
        }

        function stopPriceUpdates() {
            if (priceUpdateInterval) {
                clearInterval(priceUpdateInterval);
                priceUpdateInterval = null;
            }
        }

        // Load Firebase config from localStorage
        function loadFirebaseConfig() {
            const stored = localStorage.getItem('firebaseConfig');
            if (stored) {
                try {
                    firebaseConfig = JSON.parse(stored);
                    initializeFirebase();
                    return true;
                } catch (e) {
                    console.error('Error loading Firebase config:', e);
                }
            }
            return false;
        }

        function showFirebaseSetup() {
            document.getElementById('firebaseSetupModal').classList.remove('hidden');
        }

        function skipFirebaseSetup() {
            document.getElementById('firebaseSetupModal').classList.add('hidden');
            loadDefaultData();
            updateDashboard();
            updateTransactionLists();
            updateStatus('Lokaal (geen sync)', 'yellow');
        }

        function saveFirebaseConfig() {
            const config = {
                apiKey: document.getElementById('fbApiKey').value.trim(),
                authDomain: document.getElementById('fbAuthDomain').value.trim(),
                databaseURL: document.getElementById('fbDatabaseURL').value.trim(),
                projectId: document.getElementById('fbProjectId').value.trim()
            };

            if (!config.apiKey || !config.authDomain || !config.databaseURL || !config.projectId) {
                alert('Vul alle velden in!');
                return;
            }

            firebaseConfig = config;
            localStorage.setItem('firebaseConfig', JSON.stringify(config));
            document.getElementById('firebaseSetupModal').classList.add('hidden');
            
            initializeFirebase();
        }

        function initializeFirebase() {
            if (firebaseInitialized || !firebaseConfig) return;
            
            // Wait for Firebase modules to load
            if (!window.firebaseModules) {
                setTimeout(initializeFirebase, 100);
                return;
            }
            
            try {
                const { initializeApp, getDatabase, ref, set, get, onValue } = window.firebaseModules;
                
                const app = initializeApp(firebaseConfig);
                database = getDatabase(app);
                firebaseInitialized = true;
                
                // Store Firebase functions globally for use in other functions
                window.dbRef = ref;
                window.dbSet = set;
                window.dbGet = get;
                window.dbOnValue = onValue;
                
                updateStatus('Verbonden met Firebase', 'green');
                
                // Load data from Firebase
                loadFromFirebase();
                
                // Listen for changes
                setupFirebaseListeners();
                
            } catch (error) {
                console.error('Firebase initialization error:', error);
                updateStatus('Firebase fout - lokaal', 'red');
                loadDefaultData();
                updateDashboard();
                updateTransactionLists();
            }
        }

        function setupFirebaseListeners() {
            const { ref, onValue } = window.firebaseModules;
            
            onValue(ref(database, 'btcTransactions'), (snapshot) => {
                if (snapshot.exists()) {
                    btcTransactions = snapshot.val() || [];
                    updateDashboard();
                    updateTransactionLists();
                }
            });
            
            onValue(ref(database, 'xrpTransactions'), (snapshot) => {
                if (snapshot.exists()) {
                    xrpTransactions = snapshot.val() || [];
                    updateDashboard();
                    updateTransactionLists();
                }
            });
            
            onValue(ref(database, 'priceSnapshots'), (snapshot) => {
                if (snapshot.exists()) {
                    priceSnapshots = snapshot.val() || [];
                    updateDashboard();
                }
            });
            
            onValue(ref(database, 'currentPrices'), (snapshot) => {
                if (snapshot.exists()) {
                    const prices = snapshot.val();
                    currentBtcPrice = prices.btc || currentBtcPrice;
                    currentXrpPrice = prices.xrp || currentXrpPrice;
                    updateDashboard();
                }
            });
            
            onValue(ref(database, 'cashTransactions'), (snapshot) => {
                if (snapshot.exists()) {
                    cashTransactions = snapshot.val() || [];
                    updateDashboard();
                    updateCashChart(); // Explicitly update cash chart
                }
            });
        }

        function loadFromFirebase() {
            if (!database || !window.dbGet || !window.dbRef) {
                // No Firebase - load defaults
                console.log('‚ö†Ô∏è No Firebase connection - loading defaults');
                loadDefaultData();
                updateDashboard();
                updateTransactionLists();
                return;
            }
            
            const { ref, get } = window.firebaseModules;
            
            Promise.all([
                get(ref(database, 'btcTransactions')),
                get(ref(database, 'xrpTransactions')),
                get(ref(database, 'priceSnapshots')),
                get(ref(database, 'currentPrices')),
                get(ref(database, 'cashTransactions'))
            ]).then(([btcSnap, xrpSnap, snapSnap, pricesSnap, cashSnap]) => {
                let hasFirebaseData = false;
                
                if (btcSnap.exists() && btcSnap.val().length > 0) {
                    btcTransactions = btcSnap.val();
                    hasFirebaseData = true;
                    console.log(`‚úÖ Loaded ${btcTransactions.length} BTC transactions from Firebase`);
                }
                if (xrpSnap.exists() && xrpSnap.val().length > 0) {
                    xrpTransactions = xrpSnap.val();
                    hasFirebaseData = true;
                    console.log(`‚úÖ Loaded ${xrpTransactions.length} XRP transactions from Firebase`);
                }
                if (snapSnap.exists()) {
                    priceSnapshots = snapSnap.val() || [];
                    console.log(`‚úÖ Loaded ${priceSnapshots.length} price snapshots from Firebase`);
                }
                if (pricesSnap.exists()) {
                    const prices = pricesSnap.val();
                    currentBtcPrice = prices.btc || currentBtcPrice;
                    currentXrpPrice = prices.xrp || currentXrpPrice;
                }
                if (cashSnap.exists()) {
                    cashTransactions = cashSnap.val() || [];
                    console.log(`‚úÖ Loaded ${cashTransactions.length} cash transactions from Firebase`);
                }
                
                // If no data in Firebase, load defaults and upload them
                if (!hasFirebaseData) {
                    console.log('üìù No Firebase data found - loading defaults');
                    loadDefaultData();
                    saveToFirebase();
                } else {
                    console.log('üéâ Successfully loaded data from Firebase!');
                }
                
                updateDashboard();
                updateTransactionLists();
                
                // Explicitly update cash chart if we have cash data
                if (cashTransactions.length > 0) {
                    updateCashChart();
                }
            }).catch(error => {
                console.error('Error loading from Firebase:', error);
                console.log('‚ö†Ô∏è Loading defaults due to error');
                loadDefaultData();
                updateDashboard();
                updateTransactionLists();
            });
        }

        function saveToFirebase() {
            if (!database || !window.dbSet || !window.dbRef) {
                // Fallback to localStorage
                const data = {
                    btcTransactions,
                    xrpTransactions,
                    currentBtcPrice,
                    currentXrpPrice,
                    priceSnapshots,
                    cashTransactions
                };
                localStorage.setItem('cryptoData', JSON.stringify(data));
                return;
            }
            
            const { ref, set } = window.firebaseModules;
            
            set(ref(database, 'btcTransactions'), btcTransactions);
            set(ref(database, 'xrpTransactions'), xrpTransactions);
            set(ref(database, 'priceSnapshots'), priceSnapshots);
            set(ref(database, 'currentPrices'), {
                btc: currentBtcPrice,
                xrp: currentXrpPrice
            });
            set(ref(database, 'cashTransactions'), cashTransactions);
        }

        function updateStatus(text, color) {
            const dot = document.getElementById('statusDot');
            const statusText = document.getElementById('statusText');
            
            statusText.textContent = text;
            
            dot.className = 'w-2 h-2 rounded-full';
            if (color === 'green') {
                dot.classList.add('bg-green-500');
            } else if (color === 'yellow') {
                dot.classList.add('bg-yellow-500');
            } else if (color === 'red') {
                dot.classList.add('bg-red-500');
            } else {
                dot.classList.add('bg-gray-400');
            }
        }

        function loadDefaultData() {
    // REAL DATA from Kraken export (21 Feb 2026)
    // 30 BTC + 17 XRP = ‚Ç¨900 total
    btcTransactions = [
        { datum: '2026-01-23', bedrag: 15.0, hoeveelheid: 0.00019303, koers: 77708.12827021707, type: 'buy' },
        { datum: '2026-01-24', bedrag: 15.0, hoeveelheid: 0.0001946, koers: 77081.19218910586, type: 'buy' },
        { datum: '2026-01-25', bedrag: 15.0, hoeveelheid: 0.00019628, koers: 76421.43876095374, type: 'buy' },
        { datum: '2026-01-26', bedrag: 15.0, hoeveelheid: 0.00019916, koers: 75316.32858003615, type: 'buy' },
        { datum: '2026-01-27', bedrag: 30.0, hoeveelheid: 0.00039535, koers: 75882.1297584419, type: 'buy' },
        { datum: '2026-01-28', bedrag: 30.0, hoeveelheid: 0.00039596, koers: 75765.22881099102, type: 'buy' },
        { datum: '2026-01-29', bedrag: 30.0, hoeveelheid: 0.00040016, koers: 74970.01199520192, type: 'buy' },
        { datum: '2026-01-30', bedrag: 30.0, hoeveelheid: 0.00042504, koers: 70581.59232072276, type: 'buy' },
        { datum: '2026-01-31', bedrag: 30.0, hoeveelheid: 0.00041763, koers: 71833.91997701315, type: 'buy' },
        { datum: '2026-02-01', bedrag: 30.0, hoeveelheid: 0.00044406, koers: 67558.43804891231, type: 'buy' },
        { datum: '2026-02-02', bedrag: 30.0, hoeveelheid: 0.000455, koers: 65934.06593406593, type: 'buy' },
        { datum: '2026-02-03', bedrag: 30.0, hoeveelheid: 0.00044162, koers: 67931.70599157647, type: 'buy' },
        { datum: '2026-02-04', bedrag: 30.0, hoeveelheid: 0.00045568, koers: 65835.67415730338, type: 'buy' },
        { datum: '2026-02-05', bedrag: 15.0, hoeveelheid: 0.00024557, koers: 61082.379769515814, type: 'buy' },
        { datum: '2026-02-06', bedrag: 15.0, hoeveelheid: 0.00026848, koers: 55870.08217472575, type: 'buy' },
        { datum: '2026-02-07', bedrag: 15.0, hoeveelheid: 0.00025564, koers: 58676.26077597031, type: 'buy' },
        { datum: '2026-02-08', bedrag: 15.0, hoeveelheid: 0.00024912, koers: 60211.94630872483, type: 'buy' },
        { datum: '2026-02-09', bedrag: 15.0, hoeveelheid: 0.00024762, koers: 60576.68835154827, type: 'buy' },
        { datum: '2026-02-10', bedrag: 15.0, hoeveelheid: 0.00025419, koers: 59010.394641859695, type: 'buy' },
        { datum: '2026-02-11', bedrag: 15.0, hoeveelheid: 0.00026145, koers: 57374.09049487518, type: 'buy' },
        { datum: '2026-02-12', bedrag: 15.0, hoeveelheid: 0.00026019, koers: 57660.63308084608, type: 'buy' },
        { datum: '2026-02-13', bedrag: 15.0, hoeveelheid: 0.00026335, koers: 56957.28395061729, type: 'buy' },
        { datum: '2026-02-14', bedrag: 15.0, hoeveelheid: 0.00025124, koers: 59703.870446247804, type: 'buy' },
        { datum: '2026-02-15', bedrag: 15.0, hoeveelheid: 0.00024598, koers: 60980.56549635608, type: 'buy' },
        { datum: '2026-02-16', bedrag: 15.0, hoeveelheid: 0.00025428, koers: 58990.08966493629, type: 'buy' },
        { datum: '2026-02-17', bedrag: 15.0, hoeveelheid: 0.00025439, koers: 58968.66181874389, type: 'buy' },
        { datum: '2026-02-18', bedrag: 25.0, hoeveelheid: 0.00042597, koers: 58689.57907833885, type: 'buy' },
        { datum: '2026-02-19', bedrag: 25.0, hoeveelheid: 0.00043115, koers: 57984.45976109426, type: 'buy' },
        { datum: '2026-02-20', bedrag: 25.0, hoeveelheid: 0.00042459, koers: 58880.33215422653, type: 'buy' },
        { datum: '2026-02-21', bedrag: 25.0, hoeveelheid: 0.00042581, koers: 58711.62803924159, type: 'buy' }
    ];

    xrpTransactions = [
        { datum: '2026-02-05', bedrag: 15.0, hoeveelheid: 12.13497, koers: 1.2361028945076964, type: 'buy' },
        { datum: '2026-02-06', bedrag: 15.0, hoeveelheid: 13.42831, koers: 1.1170331653933584, type: 'buy' },
        { datum: '2026-02-07', bedrag: 15.0, hoeveelheid: 12.28213, koers: 1.2213086304304992, type: 'buy' },
        { datum: '2026-02-08', bedrag: 15.0, hoeveelheid: 12.21926, koers: 1.2275682009302713, type: 'buy' },
        { datum: '2026-02-09', bedrag: 15.0, hoeveelheid: 12.2341, koers: 1.2261079063475085, type: 'buy' },
        { datum: '2026-02-10', bedrag: 15.0, hoeveelheid: 12.31937, koers: 1.2176314637644857, type: 'buy' },
        { datum: '2026-02-11', bedrag: 15.0, hoeveelheid: 12.82329, koers: 1.1697348736121764, type: 'buy' },
        { datum: '2026-02-12', bedrag: 15.0, hoeveelheid: 12.63381, koers: 1.1872953367434892, type: 'buy' },
        { datum: '2026-02-13', bedrag: 15.0, hoeveelheid: 12.88656, koers: 1.163986449864499, type: 'buy' },
        { datum: '2026-02-14', bedrag: 15.0, hoeveelheid: 12.26338, koers: 1.2232471153846153, type: 'buy' },
        { datum: '2026-02-15', bedrag: 10.0, hoeveelheid: 10.55858, koers: 0.9471059471059471, type: 'buy' },
        { datum: '2026-02-16', bedrag: 15.0, hoeveelheid: 11.9363, koers: 1.2567093866968734, type: 'buy' },
        { datum: '2026-02-17', bedrag: 15.0, hoeveelheid: 11.81613, koers: 1.269488491295195, type: 'buy' },
        { datum: '2026-02-18', bedrag: 25.0, hoeveelheid: 15.61122, koers: 1.6014479065024074, type: 'buy' },
        { datum: '2026-02-19', bedrag: 25.0, hoeveelheid: 16.1537, koers: 1.5476397515527952, type: 'buy' },
        { datum: '2026-02-20', bedrag: 25.0, hoeveelheid: 16.23798, koers: 1.539553990962554, type: 'buy' },
        { datum: '2026-02-21', bedrag: 25.0, hoeveelheid: 16.14811, koers: 1.5481808905380332, type: 'buy' }
    ];

    // Initialize empty cash transactions
    cashTransactions = [];

    console.log('‚úÖ Loaded Kraken data: 30 BTC + 17 XRP = ‚Ç¨900 total');
}


        // Export/Import functions
        function exportData() {
            const data = {
                btcTransactions,
                xrpTransactions,
                currentBtcPrice,
                currentXrpPrice,
                priceSnapshots,
                exportedAt: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `crypto-dca-backup-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
        }

        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const data = JSON.parse(event.target.result);
                        btcTransactions = data.btcTransactions || [];
                        xrpTransactions = data.xrpTransactions || [];
                        currentBtcPrice = data.currentBtcPrice || 60576.69;
                        currentXrpPrice = data.currentXrpPrice || 1.23;
                        priceSnapshots = data.priceSnapshots || [];
                        
                        saveToFirebase();
                        updateDashboard();
                        updateTransactionLists();
                        alert('Data succesvol ge√Ømporteerd!');
                    } catch (error) {
                        alert('Fout bij importeren van data.');
                        console.error(error);
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        // ========== CASH MANAGEMENT FUNCTIONS ==========
        
        function calculateCashBalance() {
            let balance = 0;
            const sorted = [...cashTransactions].sort((a, b) => new Date(a.datum) - new Date(b.datum));
            
            sorted.forEach(t => {
                if (t.type === 'funding') balance += t.bedrag;
                else if (t.type === 'buy') balance -= t.bedrag;
                else if (t.type === 'sell') balance += t.bedrag;
            });
            
            return balance;
        }

        function addCashFunding() {
            const datum = document.getElementById('cashDatum').value;
            const bedrag = parseFloat(document.getElementById('cashBedrag').value);
            
            if (!datum || !bedrag || bedrag <= 0) {
                alert('Vul datum en bedrag in!');
                return;
            }
            
            cashTransactions.push({
                datum,
                type: 'funding',
                bedrag,
                notes: 'Wekelijkse funding'
            });
            
            cashTransactions.sort((a, b) => new Date(a.datum) - new Date(b.datum));
            
            saveToFirebase();
            updateDashboard();
            
            document.getElementById('cashBedrag').value = '';
            
            alert(`‚úÖ ‚Ç¨${bedrag.toFixed(2)} toegevoegd aan cash!`);
        }

        // Calculate current holdings for a crypto
        function calculateHoldings(crypto) {
            const transactions = crypto === 'BTC' ? btcTransactions : xrpTransactions;
            let holdings = 0;
            transactions.forEach(t => {
                if (t.type === 'sell') {
                    holdings -= t.hoeveelheid;
                } else {
                    holdings += t.hoeveelheid;
                }
            });
            return holdings;
        }

        // Update available holdings display
        function updateSellHoldings() {
            const crypto = document.getElementById('sellCrypto').value;
            const holdings = calculateHoldings(crypto);
            const decimals = crypto === 'BTC' ? 8 : 2;
            document.getElementById('availableHoldings').textContent = holdings.toFixed(decimals) + ' ' + crypto;
            updateSellPreview();
        }

        // Update sell preview with profit calculation
        function updateSellPreview() {
            const crypto = document.getElementById('sellCrypto').value;
            const hoeveelheid = parseFloat(document.getElementById('sellHoeveelheid').value) || 0;
            const koers = parseFloat(document.getElementById('sellKoers').value) || 0;
            
            if (hoeveelheid <= 0 || koers <= 0) {
                document.getElementById('sellPreview').classList.add('hidden');
                return;
            }
            
            const bedrag = hoeveelheid * koers;
            
            // Calculate cost basis (FIFO)
            const transactions = crypto === 'BTC' ? btcTransactions : xrpTransactions;
            let remainingToSell = hoeveelheid;
            let totalCost = 0;
            
            for (let t of transactions) {
                if (t.type === 'sell') continue;
                if (remainingToSell <= 0) break;
                
                const sellFromThis = Math.min(remainingToSell, t.hoeveelheid);
                totalCost += sellFromThis * t.koers;
                remainingToSell -= sellFromThis;
            }
            
            const profit = bedrag - totalCost;
            
            document.getElementById('sellOntvangst').textContent = '‚Ç¨' + bedrag.toFixed(2);
            document.getElementById('sellCostBasis').textContent = '‚Ç¨' + totalCost.toFixed(2);
            document.getElementById('sellProfit').textContent = '‚Ç¨' + profit.toFixed(2);
            document.getElementById('sellProfit').className = 'text-lg font-bold ' + (profit >= 0 ? 'text-green-600' : 'text-red-600');
            
            document.getElementById('sellPreview').classList.remove('hidden');
        }

        // Sell crypto using form
        function sellCrypto() {
            const datum = document.getElementById('sellDatum').value;
            const crypto = document.getElementById('sellCrypto').value;
            const hoeveelheid = parseFloat(document.getElementById('sellHoeveelheid').value);
            const koers = parseFloat(document.getElementById('sellKoers').value);
            
            if (!datum || !hoeveelheid || !koers || hoeveelheid <= 0 || koers <= 0) {
                alert('Vul alle velden correct in!');
                return;
            }
            
            // Check holdings
            const holdings = calculateHoldings(crypto);
            if (hoeveelheid > holdings) {
                alert(`‚ùå Onvoldoende ${crypto}!\n\nBeschikbaar: ${holdings.toFixed(crypto === 'BTC' ? 8 : 2)} ${crypto}\nGevraagd: ${hoeveelheid.toFixed(crypto === 'BTC' ? 8 : 2)} ${crypto}`);
                return;
            }
            
            const bedrag = hoeveelheid * koers;
            
            // Calculate cost basis (FIFO)
            const transactions = crypto === 'BTC' ? btcTransactions : xrpTransactions;
            let remainingToSell = hoeveelheid;
            let totalCost = 0;
            
            for (let t of transactions) {
                if (t.type === 'sell') continue;
                if (remainingToSell <= 0) break;
                
                const sellFromThis = Math.min(remainingToSell, t.hoeveelheid);
                totalCost += sellFromThis * t.koers;
                remainingToSell -= sellFromThis;
            }
            
            const profit = bedrag - totalCost;
            
            if (!confirm(`Verkopen:\n\n${hoeveelheid.toFixed(crypto === 'BTC' ? 8 : 2)} ${crypto} @ ‚Ç¨${koers.toFixed(2)}\n= ‚Ç¨${bedrag.toFixed(2)} ontvangen\n\nCost basis: ‚Ç¨${totalCost.toFixed(2)}\nProfit: ‚Ç¨${profit.toFixed(2)}\n\nDoorgaan?`)) {
                return;
            }
            
            // Add SELL transaction
            const sellTransaction = {
                datum,
                bedrag,
                hoeveelheid,
                koers,
                type: 'sell',
                profit: profit
            };
            
            if (crypto === 'BTC') {
                btcTransactions.push(sellTransaction);
                btcTransactions.sort((a, b) => new Date(a.datum) - new Date(b.datum));
            } else {
                xrpTransactions.push(sellTransaction);
                xrpTransactions.sort((a, b) => new Date(a.datum) - new Date(b.datum));
            }
            
            // Add cash from sale
            cashTransactions.push({
                datum,
                type: 'sell',
                bedrag,
                crypto,
                notes: `${crypto} verkoop (${hoeveelheid.toFixed(crypto === 'BTC' ? 8 : 2)} @ ‚Ç¨${koers.toFixed(2)}) - Profit: ‚Ç¨${profit.toFixed(2)}`
            });
            cashTransactions.sort((a, b) => new Date(a.datum) - new Date(b.datum));
            
            // Clear form
            document.getElementById('sellHoeveelheid').value = '';
            document.getElementById('sellKoers').value = '';
            document.getElementById('sellPreview').classList.add('hidden');
            
            saveToFirebase();
            updateDashboard();
            updateTransactionLists();
            updateSellHoldings();
            
            alert(`‚úÖ Verkocht!\n\n‚Ç¨${bedrag.toFixed(2)} cash ontvangen\nRealized profit: ‚Ç¨${profit.toFixed(2)}\n\nNieuw ${crypto} holdings: ${(holdings - hoeveelheid).toFixed(crypto === 'BTC' ? 8 : 2)}`);
        }

        function updateCashChart() {
            if (cashTransactions.length === 0) {
                // Show empty chart
                if (window.cashChart) window.cashChart.destroy();
                const ctx = document.getElementById('cashChart');
                if (!ctx) return;
                
                window.cashChart = new Chart(ctx.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: ['Start'],
                        datasets: [{
                            label: 'Cash Saldo (‚Ç¨)',
                            data: [0],
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            tension: 0.1,
                            borderWidth: 2,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: { legend: { display: true } },
                        scales: { y: { beginAtZero: true } }
                    }
                });
                return;
            }
            
            const sorted = [...cashTransactions].sort((a, b) => new Date(a.datum) - new Date(b.datum));
            
            let balance = 0;
            const cashData = sorted.map(t => {
                if (t.type === 'funding') balance += t.bedrag;
                else if (t.type === 'buy') balance -= t.bedrag;
                else if (t.type === 'sell') balance += t.bedrag;
                
                return {
                    datum: new Date(t.datum).toLocaleDateString('nl-NL', { day: '2-digit', month: 'short' }),
                    balance: balance
                };
            });
            
            if (window.cashChart && typeof window.cashChart.destroy === 'function') {
                window.cashChart.destroy();
            }
            
            const ctx = document.getElementById('cashChart');
            if (!ctx) return;
            
            window.cashChart = new Chart(ctx.getContext('2d'), {
                type: 'line',
                data: {
                    labels: cashData.map(d => d.datum),
                    datasets: [{
                        label: 'Cash Saldo (‚Ç¨)',
                        data: cashData.map(d => d.balance),
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        tension: 0.1,
                        borderWidth: 2,
                        pointRadius: 4,
                        pointHoverRadius: 6,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: { 
                        legend: { display: true },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return '‚Ç¨' + context.parsed.y.toFixed(2);
                                }
                            }
                        }
                    },
                    scales: { 
                        y: { 
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '‚Ç¨' + value;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // ========== END CASH MANAGEMENT FUNCTIONS ==========


        // Transaction functions
        function updateCurrentPrices() {
            const btcPrice = parseFloat(document.getElementById('huidigebtcKoers').value);
            const xrpPrice = parseFloat(document.getElementById('huidigexrpKoers').value);
            const datum = document.getElementById('snapshotDatum').value;

            if (!datum) {
                alert('Vul eerst een datum in!');
                return;
            }

            if ((!btcPrice || btcPrice <= 0) && (!xrpPrice || xrpPrice <= 0)) {
                alert('Vul minimaal √©√©n geldige koers in!');
                return;
            }

            if (btcPrice && btcPrice > 0) currentBtcPrice = btcPrice;
            if (xrpPrice && xrpPrice > 0) currentXrpPrice = xrpPrice;

            const existingIndex = priceSnapshots.findIndex(s => s.datum === datum);
            
            if (existingIndex >= 0) {
                if (btcPrice && btcPrice > 0) priceSnapshots[existingIndex].btcKoers = btcPrice;
                if (xrpPrice && xrpPrice > 0) priceSnapshots[existingIndex].xrpKoers = xrpPrice;
            } else {
                priceSnapshots.push({
                    datum: datum,
                    btcKoers: btcPrice && btcPrice > 0 ? btcPrice : currentBtcPrice,
                    xrpKoers: xrpPrice && xrpPrice > 0 ? xrpPrice : currentXrpPrice
                });
                priceSnapshots.sort((a, b) => new Date(a.datum) - new Date(b.datum));
            }

            document.getElementById('huidigebtcKoers').value = '';
            document.getElementById('huidigexrpKoers').value = '';
            document.getElementById('snapshotDatum').value = new Date().toISOString().split('T')[0];
            
            saveToFirebase();
            alert('Koersen opgeslagen!');
            document.getElementById('dashboardTab').click();
        }

        function addTransaction() {
            const datum = document.getElementById('inputDatum').value;
            const crypto = document.getElementById('inputCrypto').value;
            const bedrag = parseFloat(document.getElementById('inputBedrag').value);
            const hoeveelheid = parseFloat(document.getElementById('inputHoeveelheid').value);

            if (!datum || !bedrag || !hoeveelheid || bedrag <= 0 || hoeveelheid <= 0) {
                alert('Vul alle velden correct in!');
                return;
            }

            // Check cash balance
            const currentCash = calculateCashBalance();
            if (currentCash < bedrag) {
                if (!confirm(`‚ö†Ô∏è Onvoldoende cash!\n\nBeschikbaar: ‚Ç¨${currentCash.toFixed(2)}\nNodig: ‚Ç¨${bedrag.toFixed(2)}\n\nToch doorgaan?`)) {
                    return;
                }
            }

            const koers = bedrag / hoeveelheid;
            const transaction = { 
                datum, 
                bedrag, 
                hoeveelheid, 
                koers,
                type: 'buy'  // NEW: Track transaction type
            };

            if (crypto === 'BTC') {
                btcTransactions.push(transaction);
                btcTransactions.sort((a, b) => new Date(a.datum) - new Date(b.datum));
            } else {
                xrpTransactions.push(transaction);
                xrpTransactions.sort((a, b) => new Date(a.datum) - new Date(b.datum));
            }

            // Deduct cash
            cashTransactions.push({
                datum,
                type: 'buy',
                bedrag,
                crypto,
                notes: `${crypto} aankoop`
            });
            cashTransactions.sort((a, b) => new Date(a.datum) - new Date(b.datum));

            document.getElementById('inputBedrag').value = '';
            document.getElementById('inputHoeveelheid').value = '';
            document.getElementById('koersPreview').classList.add('hidden');

            saveToFirebase();
            updateDashboard();
            updateTransactionLists();
            alert('Aankoop toegevoegd! Cash: ‚Ç¨' + calculateCashBalance().toFixed(2));
        }

        function deleteTransaction(index, crypto) {
            const transaction = crypto === 'BTC' ? btcTransactions[index] : xrpTransactions[index];
            const isSell = transaction.type === 'sell';
            const actionType = isSell ? 'verkoop' : 'aankoop';
            
            if (confirm(`Weet je zeker dat je deze ${actionType} wilt verwijderen?`)) {
                // Find and remove associated cash transaction
                const cashIndex = cashTransactions.findIndex(ct => 
                    ct.datum === transaction.datum && 
                    ct.crypto === crypto && 
                    ct.type === (isSell ? 'sell' : 'buy') &&
                    Math.abs(ct.bedrag - transaction.bedrag) < 0.01
                );
                
                if (cashIndex !== -1) {
                    cashTransactions.splice(cashIndex, 1);
                }
                
                // Remove the crypto transaction
                if (crypto === 'BTC') {
                    btcTransactions.splice(index, 1);
                } else {
                    xrpTransactions.splice(index, 1);
                }
                
                saveToFirebase();
                updateDashboard();
                updateTransactionLists();
            }
        }

        // Tab switching
        document.getElementById('dashboardTab').addEventListener('click', function() {
            document.getElementById('dashboardContent').classList.remove('hidden');
            document.getElementById('inputContent').classList.add('hidden');
            this.classList.add('border-b-2', 'border-blue-600', 'text-blue-600');
            this.classList.remove('text-gray-600');
            document.getElementById('inputTab').classList.remove('border-b-2', 'border-blue-600', 'text-blue-600');
            document.getElementById('inputTab').classList.add('text-gray-600');
            updateDashboard();
        });

        document.getElementById('inputTab').addEventListener('click', function() {
            document.getElementById('inputContent').classList.remove('hidden');
            document.getElementById('dashboardContent').classList.add('hidden');
            this.classList.add('border-b-2', 'border-blue-600', 'text-blue-600');
            this.classList.remove('text-gray-600');
            document.getElementById('dashboardTab').classList.remove('border-b-2', 'border-blue-600', 'text-blue-600');
            document.getElementById('dashboardTab').classList.add('text-gray-600');
            updateTransactionLists();
        });

        // Input handlers
        document.getElementById('inputBedrag').addEventListener('input', updateKoersPreview);
        document.getElementById('inputHoeveelheid').addEventListener('input', updateKoersPreview);
        document.getElementById('inputCrypto').addEventListener('change', updateKoersPreview);

        function updateKoersPreview() {
            const bedrag = parseFloat(document.getElementById('inputBedrag').value);
            const hoeveelheid = parseFloat(document.getElementById('inputHoeveelheid').value);
            const crypto = document.getElementById('inputCrypto').value;

            if (bedrag && hoeveelheid && bedrag > 0 && hoeveelheid > 0) {
                const koers = bedrag / hoeveelheid;
                document.getElementById('koersPreview').classList.remove('hidden');
                document.getElementById('berekendKoers').textContent = '‚Ç¨' + koers.toFixed(2);
                document.getElementById('koersPer').textContent = 'per ' + crypto;
            } else {
                document.getElementById('koersPreview').classList.add('hidden');
            }
        }

        function updateTransactionLists() {
            const btcList = document.getElementById('btcList');
            btcList.innerHTML = '';
            let btcTotaalBedrag = 0;
            let btcTotaalCrypto = 0;

            btcTransactions.forEach((t, i) => {
                // Handle buy vs sell
                if (t.type === 'sell') {
                    btcTotaalBedrag -= t.bedrag;  // Money OUT
                    btcTotaalCrypto -= t.hoeveelheid;  // Crypto OUT
                } else {
                    btcTotaalBedrag += t.bedrag;  // Money IN
                    btcTotaalCrypto += t.hoeveelheid;  // Crypto IN
                }
                
                const item = document.createElement('div');
                const isSell = t.type === 'sell';
                item.className = 'flex items-center justify-between p-3 rounded-lg hover:bg-gray-100 ' + (isSell ? 'bg-orange-50 border border-orange-200' : 'bg-gray-50');
                item.innerHTML = `
                    <div class="flex-1">
                        <p class="font-medium text-gray-900 text-sm">
                            ${new Date(t.datum).toLocaleDateString('nl-NL')}
                            ${isSell ? '<span class="ml-2 text-xs bg-orange-500 text-white px-2 py-0.5 rounded">SELL</span>' : ''}
                        </p>
                        <p class="text-xs text-gray-600">${isSell ? '-' : ''}‚Ç¨${t.bedrag.toFixed(2)} ‚Ä¢ ${isSell ? '-' : ''}${t.hoeveelheid.toFixed(8)} BTC</p>
                        <p class="text-xs text-gray-500">‚Ç¨${t.koers.toFixed(2)}${isSell && t.profit ? ' ‚Ä¢ Profit: ‚Ç¨' + t.profit.toFixed(2) : ''}</p>
                    </div>
                    <button onclick="deleteTransaction(${i}, 'BTC')" class="text-red-500 hover:text-red-700 p-2">
                        üóëÔ∏è
                    </button>
                `;
                btcList.appendChild(item);
            });

            document.getElementById('btcTotaalInleg').textContent = '‚Ç¨' + btcTotaalBedrag.toFixed(2);
            document.getElementById('btcTotaalHoeveelheid').textContent = btcTotaalCrypto.toFixed(8);

            const xrpList = document.getElementById('xrpList');
            xrpList.innerHTML = '';
            let xrpTotaalBedrag = 0;
            let xrpTotaalCrypto = 0;

            xrpTransactions.forEach((t, i) => {
                // Handle buy vs sell
                if (t.type === 'sell') {
                    xrpTotaalBedrag -= t.bedrag;
                    xrpTotaalCrypto -= t.hoeveelheid;
                } else {
                    xrpTotaalBedrag += t.bedrag;
                    xrpTotaalCrypto += t.hoeveelheid;
                }
                
                const item = document.createElement('div');
                const isSell = t.type === 'sell';
                item.className = 'flex items-center justify-between p-3 rounded-lg hover:bg-gray-100 ' + (isSell ? 'bg-orange-50 border border-orange-200' : 'bg-gray-50');
                item.innerHTML = `
                    <div class="flex-1">
                        <p class="font-medium text-gray-900 text-sm">
                            ${new Date(t.datum).toLocaleDateString('nl-NL')}
                            ${isSell ? '<span class="ml-2 text-xs bg-orange-500 text-white px-2 py-0.5 rounded">SELL</span>' : ''}
                        </p>
                        <p class="text-xs text-gray-600">${isSell ? '-' : ''}‚Ç¨${t.bedrag.toFixed(2)} ‚Ä¢ ${isSell ? '-' : ''}${t.hoeveelheid.toFixed(2)} XRP</p>
                        <p class="text-xs text-gray-500">‚Ç¨${t.koers.toFixed(2)}${isSell && t.profit ? ' ‚Ä¢ Profit: ‚Ç¨' + t.profit.toFixed(2) : ''}</p>
                    </div>
                    <button onclick="deleteTransaction(${i}, 'XRP')" class="text-red-500 hover:text-red-700 p-2">
                        üóëÔ∏è
                    </button>
                `;
                xrpList.appendChild(item);
            });

            document.getElementById('xrpTotaalInleg').textContent = '‚Ç¨' + xrpTotaalBedrag.toFixed(2);
            document.getElementById('xrpTotaalHoeveelheid').textContent = xrpTotaalCrypto.toFixed(2);
        }

        function calculateData(transactions, currentPrice, crypto) {
            let cumulatiefInvested = 0;  // Money IN (buys) - OUT (sells)
            let cumulatiefHoeveelheid = 0;  // Net holdings
            let realizedProfit = 0;  // Total profit from sells
            const today = new Date().toISOString().split('T')[0];
            
            return transactions.map((t, index) => {
                // Handle buy vs sell
                if (t.type === 'sell') {
                    cumulatiefInvested -= t.bedrag;  // Money came back
                    cumulatiefHoeveelheid -= t.hoeveelheid;  // Sold coins
                    realizedProfit += (t.profit || 0);  // Track profit
                } else {
                    // Buy (or old transaction without type field)
                    cumulatiefInvested += t.bedrag;
                    cumulatiefHoeveelheid += t.hoeveelheid;
                }
                
                let priceToUse;
                
                // For today's date, ALWAYS use live price
                if (t.datum === today) {
                    priceToUse = currentPrice;
                } else {
                    // For historical dates, use snapshot if available
                    const snapshot = priceSnapshots.find(s => s.datum === t.datum);
                    if (snapshot) {
                        priceToUse = crypto === 'BTC' ? snapshot.btcKoers : snapshot.xrpKoers;
                    } else {
                        // No snapshot? Use transaction price
                        priceToUse = t.koers;
                    }
                }
                
                const waarde = cumulatiefHoeveelheid * priceToUse;
                const unrealizedPL = waarde - cumulatiefInvested;
                const totalPL = realizedProfit + unrealizedPL;
                const rendement = cumulatiefInvested > 0 ? ((waarde / cumulatiefInvested) - 1) * 100 : 0;
                
                return {
                    datum: new Date(t.datum).toLocaleDateString('nl-NL', { day: '2-digit', month: 'short' }),
                    cumulatief: cumulatiefInvested,  // Net invested (buys - sells)
                    waarde: waarde,
                    rendement: rendement,
                    amount: cumulatiefHoeveelheid,  // Net holdings
                    realizedProfit: realizedProfit,
                    unrealizedPL: unrealizedPL,
                    totalPL: totalPL,
                    priceUsed: priceToUse
                };
            });
        }

        function updateDashboard() {
            if (btcTransactions.length === 0 || xrpTransactions.length === 0) return;

            const btcData = calculateData(btcTransactions, currentBtcPrice, 'BTC');
            const xrpData = calculateData(xrpTransactions, currentXrpPrice, 'XRP');

            const btcLast = btcData[btcData.length - 1];
            const xrpLast = xrpData[xrpData.length - 1];

            const totaalInleg = btcLast.cumulatief + xrpLast.cumulatief;
            const totaalWaarde = btcLast.waarde + xrpLast.waarde;
            const totaalRendement = ((totaalWaarde / totaalInleg) - 1) * 100;

            const btcGemKoers = btcLast.cumulatief / btcLast.amount;
            const xrpGemKoers = xrpLast.cumulatief / xrpLast.amount;

            // Calculate totals
            const totalRealized = btcLast.realizedProfit + xrpLast.realizedProfit;
            const totalUnrealized = btcLast.unrealizedPL + xrpLast.unrealizedPL;
            const totalPL = totalRealized + totalUnrealized;

            document.getElementById('totaleInleg').textContent = '‚Ç¨' + totaalInleg.toFixed(2);
            document.getElementById('huidigeWaarde').textContent = '‚Ç¨' + totaalWaarde.toFixed(2);
            document.getElementById('rendementBedrag').textContent = '‚Ç¨' + totalPL.toFixed(2);
            document.getElementById('realizedPL').textContent = '‚Ç¨' + totalRealized.toFixed(2);
            document.getElementById('unrealizedPL').textContent = '‚Ç¨' + totalUnrealized.toFixed(2);
            document.getElementById('realizedPL').className = totalRealized >= 0 ? 'font-semibold text-green-600' : 'font-semibold text-red-600';
            document.getElementById('unrealizedPL').className = totalUnrealized >= 0 ? 'font-semibold text-green-600' : 'font-semibold text-red-600';
            document.getElementById('rendementCard').style.borderLeftColor = totalPL >= 0 ? '#10b981' : '#ef4444';
            
            document.getElementById('btcGemKoers').textContent = '‚Ç¨' + btcGemKoers.toFixed(2);
            document.getElementById('btcHoeveelheid').textContent = btcLast.amount.toFixed(6) + ' BTC';
            
            document.getElementById('xrpGemKoers').textContent = '‚Ç¨' + xrpGemKoers.toFixed(2);
            document.getElementById('xrpHoeveelheid').textContent = xrpLast.amount.toFixed(2) + ' XRP';

            // Update cash balance
            const cashBalance = calculateCashBalance();
            document.getElementById('cashSaldo').textContent = '‚Ç¨' + cashBalance.toFixed(2);

            updateCharts(btcData, xrpData);
            updateCashChart();
        }

        function updateCharts(btcData, xrpData) {
            if (btcChart) btcChart.destroy();
            const btcCtx = document.getElementById('btcChart').getContext('2d');
            btcChart = new Chart(btcCtx, {
                type: 'line',
                data: {
                    labels: btcData.map(d => d.datum),
                    datasets: [{
                        label: 'Inleg',
                        data: btcData.map(d => d.cumulatief),
                        borderColor: '#6b7280',
                        backgroundColor: 'rgba(107, 114, 128, 0.1)',
                        tension: 0.1
                    }, {
                        label: 'Waarde',
                        data: btcData.map(d => d.waarde),
                        borderColor: '#F7931A',
                        backgroundColor: 'rgba(247, 147, 26, 0.1)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: { legend: { display: true } },
                    scales: { y: { beginAtZero: false } }
                }
            });

            if (xrpChart) xrpChart.destroy();
            const xrpCtx = document.getElementById('xrpChart').getContext('2d');
            xrpChart = new Chart(xrpCtx, {
                type: 'line',
                data: {
                    labels: xrpData.map(d => d.datum),
                    datasets: [{
                        label: 'Inleg',
                        data: xrpData.map(d => d.cumulatief),
                        borderColor: '#6b7280',
                        backgroundColor: 'rgba(107, 114, 128, 0.1)',
                        tension: 0.1
                    }, {
                        label: 'Waarde',
                        data: xrpData.map(d => d.waarde),
                        borderColor: '#F7931A',
                        backgroundColor: 'rgba(247, 147, 26, 0.1)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: { legend: { display: true } },
                    scales: { y: { beginAtZero: false } }
                }
            });

            if (rendementChart) rendementChart.destroy();
            const rendCtx = document.getElementById('rendementChart').getContext('2d');
            const allDates = btcData.map(d => d.datum);
            
            rendementChart = new Chart(rendCtx, {
                type: 'line',
                data: {
                    labels: allDates,
                    datasets: [{
                        label: 'BTC %',
                        data: btcData.map(d => d.rendement),
                        borderColor: '#F7931A',
                        backgroundColor: 'rgba(247, 147, 26, 0.1)',
                        tension: 0.1,
                        borderWidth: 2
                    }, {
                        label: 'XRP %',
                        data: allDates.map(date => {
                            const xrpPoint = xrpData.find(d => d.datum === date);
                            return xrpPoint ? xrpPoint.rendement : null;
                        }),
                        borderColor: '#23292F',
                        backgroundColor: 'rgba(35, 41, 47, 0.1)',
                        tension: 0.1,
                        borderWidth: 2,
                        spanGaps: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: { 
                        legend: { display: true },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + (context.parsed.y ? context.parsed.y.toFixed(1) + '%' : 'N/A');
                                }
                            }
                        }
                    }
                }
            });
        }

        function exportToExcel() {
            const wb = XLSX.utils.book_new();

            const btcTransactiesData = [['Datum', 'Bedrag (‚Ç¨)', 'Hoeveelheid (BTC)', 'Koers (‚Ç¨)']];
            btcTransactions.forEach(t => {
                btcTransactiesData.push([t.datum, t.bedrag, t.hoeveelheid, t.koers]);
            });
            const ws1 = XLSX.utils.aoa_to_sheet(btcTransactiesData);
            XLSX.utils.book_append_sheet(wb, ws1, 'BTC Transacties');

            const xrpTransactiesData = [['Datum', 'Bedrag (‚Ç¨)', 'Hoeveelheid (XRP)', 'Koers (‚Ç¨)']];
            xrpTransactions.forEach(t => {
                xrpTransactiesData.push([t.datum, t.bedrag, t.hoeveelheid, t.koers]);
            });
            const ws2 = XLSX.utils.aoa_to_sheet(xrpTransactiesData);
            XLSX.utils.book_append_sheet(wb, ws2, 'XRP Transacties');

            const snapshotsData = [['Datum', 'BTC Koers (‚Ç¨)', 'XRP Koers (‚Ç¨)']];
            priceSnapshots.forEach(s => {
                snapshotsData.push([s.datum, s.btcKoers, s.xrpKoers]);
            });
            const ws3 = XLSX.utils.aoa_to_sheet(snapshotsData);
            XLSX.utils.book_append_sheet(wb, ws3, 'Koers Snapshots');

            const btcData = calculateData(btcTransactions, currentBtcPrice, 'BTC');
            const xrpData = calculateData(xrpTransactions, currentXrpPrice, 'XRP');
            const btcLast = btcData[btcData.length - 1];
            const xrpLast = xrpData[xrpData.length - 1];

            const portfolioData = [
                ['Metric', 'BTC', 'XRP', 'Totaal'],
                ['Totale Inleg (‚Ç¨)', btcLast.cumulatief, xrpLast.cumulatief, btcLast.cumulatief + xrpLast.cumulatief],
                ['Huidige Waarde (‚Ç¨)', btcLast.waarde, xrpLast.waarde, btcLast.waarde + xrpLast.waarde],
                ['Rendement (‚Ç¨)', btcLast.waarde - btcLast.cumulatief, xrpLast.waarde - xrpLast.cumulatief, (btcLast.waarde + xrpLast.waarde) - (btcLast.cumulatief + xrpLast.cumulatief)],
                ['Rendement (%)', btcLast.rendement, xrpLast.rendement, ((btcLast.waarde + xrpLast.waarde) / (btcLast.cumulatief + xrpLast.cumulatief) - 1) * 100],
                ['Totale Hoeveelheid', btcLast.amount, xrpLast.amount, '-'],
                ['Gem. Aankoopprijs (‚Ç¨)', btcLast.cumulatief / btcLast.amount, xrpLast.cumulatief / xrpLast.amount, '-'],
                ['Huidige Koers (‚Ç¨)', currentBtcPrice, currentXrpPrice, '-']
            ];
            const ws4 = XLSX.utils.aoa_to_sheet(portfolioData);
            XLSX.utils.book_append_sheet(wb, ws4, 'Portfolio Overzicht');

            const today = new Date().toISOString().split('T')[0];
            const filename = `Crypto_DCA_Dashboard_${today}.xlsx`;
            XLSX.writeFile(wb, filename);
        }

        // Initialize
        window.addEventListener('load', function() {
            document.getElementById('inputDatum').value = new Date().toISOString().split('T')[0];
            document.getElementById('snapshotDatum').value = new Date().toISOString().split('T')[0];
            document.getElementById('cashDatum').value = new Date().toISOString().split('T')[0];
            document.getElementById('sellDatum').value = new Date().toISOString().split('T')[0];
            
            // Initialize sell holdings display
            updateSellHoldings();
            
            updateStatus('Verbinden...', 'gray');
            
            // DON'T load default data immediately - let Firebase load first
            // If Firebase has no data, it will call loadDefaultData()
            
            // Auto-initialize Firebase with pre-configured settings
            // This will load data from Firebase OR defaults if empty
            initializeFirebase();
            
            // Start live price updates with a small delay to let page load
            setTimeout(() => {
                console.log('üöÄ Starting price updates...');
                startPriceUpdates();
            }, 1000);
            
            // Backfill historical prices after Firebase loads
            setTimeout(() => {
                console.log('üìä Starting backfill...');
                backfillHistoricalPrices();
            }, 3000);
        });
        
        // Stop updates when page closes
        window.addEventListener('beforeunload', function() {
            stopPriceUpdates();
        });
    </script>
</body>
</html>
